---
phase: 01-roast-capture-logs
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/roast-session/derive.ts
  - src/domain/roast-session/types.ts
  - src/data/roasts.ts
  - src/features/roast-log/PreRoastForm.tsx
  - src/features/roast-log/PostRoastForm.tsx
  - src/features/roast-log/ReviewScreen.tsx
  - src/features/timer/timerStore.ts
  - src/features/timer/TimerScreen.tsx
  - src/features/timer/TimerControls.tsx
autonomous: false
gap_closure: true
must_haves:
  truths:
    - "Split timers count up live once started"
    - "Timer controls do not obstruct split timers on mobile"
    - "Roast level is captured at end of roast with roasted weight"
    - "Review shows roast yield % computed as roasted / green * 100"
  artifacts:
    - path: "src/features/timer/TimerScreen.tsx"
      provides: "Live split timer rendering and layout spacing"
    - path: "src/features/timer/timerStore.ts"
      provides: "Capture flow state for pre/post roast fields"
    - path: "src/features/roast-log/PostRoastForm.tsx"
      provides: "Post-roast capture of roasted weight and roast level"
    - path: "src/domain/roast-session/derive.ts"
      provides: "Yield % calculation helper"
    - path: "src/features/roast-log/ReviewScreen.tsx"
      provides: "Review summary using yield %"
  key_links:
    - from: "src/features/timer/TimerScreen.tsx"
      to: "src/features/timer/timerStore.ts"
      via: "live timer selectors + Date.now() refresh"
      pattern: "useEffect.*setInterval|requestAnimationFrame"
    - from: "src/features/roast-log/PostRoastForm.tsx"
      to: "src/features/timer/timerStore.ts"
      via: "setPostRoastFields"
      pattern: "roastLevel"
    - from: "src/features/roast-log/ReviewScreen.tsx"
      to: "src/domain/roast-session/derive.ts"
      via: "yield % helper"
      pattern: "yield"
---

<objective>
Close Phase 1 verification gaps around live split timers, mobile layout, and end-of-roast capture details.

Purpose: Align the capture flow with locked decisions and correct the roast metric displayed/saved.
Output: Updated timer UI, capture flow, and yield % derivation reflected across review and persistence.
</objective>

<execution_context>
@/Users/bobsmachine/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bobsmachine/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-roast-capture-logs/01-roast-capture-logs-VERIFICATION.md
@.planning/phases/01-roast-capture-logs/01-CONTEXT.md
@src/features/timer/TimerScreen.tsx
@src/features/timer/TimerControls.tsx
@src/features/timer/timerStore.ts
@src/features/roast-log/PreRoastForm.tsx
@src/features/roast-log/PostRoastForm.tsx
@src/features/roast-log/ReviewScreen.tsx
@src/domain/roast-session/derive.ts
@src/domain/roast-session/types.ts
@src/data/roasts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move roast level to post-roast and switch to yield %</name>
  <files>src/features/roast-log/PreRoastForm.tsx, src/features/roast-log/PostRoastForm.tsx, src/features/roast-log/ReviewScreen.tsx, src/features/timer/timerStore.ts, src/domain/roast-session/derive.ts, src/domain/roast-session/types.ts, src/data/roasts.ts</files>
  <action>
Update the capture flow so roast level is captured with roasted weight after Stop. Remove roast level inputs/validation from the pre-roast form; add roast level selection to the post-roast form alongside roasted weight and wire it into the timer store's post-roast fields. Update the store shape/types to reflect the new field placement and ensure review requires roast level and roasted weight before enabling save.

Replace loss % with yield % (roasted / green * 100) in the derivation helper and review summary. Rename fields/types if needed so persisted roast records store yield percent (not loss percent), and update any labels in review to “Yield %”. Keep validation rules intact: green and roasted weights > 0 and roasted <= green.
  </action>
  <verify>npm run lint</verify>
  <done>Roast level is only captured after Stop with roasted weight, and review + persisted records use yield % instead of loss %.</done>
</task>

<task type="auto">
  <name>Task 2: Make split timers live and fix mobile control overlap</name>
  <files>src/features/timer/TimerScreen.tsx, src/features/timer/TimerControls.tsx</files>
  <action>
Adjust the timer display so development and cooling timers count up live once their start marker exists. Use a lightweight ticking “now” value (interval or animation frame) only to refresh the display; compute live split durations from the recorded event timestamps and the current time when the end marker is not yet set. Keep total timer behavior consistent with existing event-log derivations.

Update the timer layout to guarantee the sticky control bar never overlaps split timers on small screens. Add explicit spacing/padding and/or reposition split timers so they remain fully visible above the controls in mobile view, while maintaining the full-screen, minimal-chrome layout.
  </action>
  <verify>npm run lint</verify>
  <done>Split timers tick up live during the roast and remain unobstructed by controls on mobile-sized viewports.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify live timers and end-of-roast capture</name>
  <action>Confirm the updated UI flow and layout match the gap closure requirements.</action>
  <what-built>Live split timers, mobile-safe layout, and end-of-roast roast level + yield %</what-built>
  <how-to-verify>
    1. Start a roast, set First Crack, confirm development timer counts up live.
    2. Set Drop, confirm cooling timer counts up live until Stop.
    3. On a mobile-sized viewport, confirm split timers are not covered by the sticky controls.
    4. Stop the roast, enter roasted weight and roast level together, review shows Yield %.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
Manual verification required for full roast flow, persistence on refresh, discard confirmation, and delete-latest roast (per verification report).
</verification>

<success_criteria>
All Phase 1 gap items are resolved: live split timers, unobstructed controls on mobile, roast level captured post-roast, and yield % used everywhere instead of loss %.
</success_criteria>

<output>
After completion, create `.planning/phases/01-roast-capture-logs/01-04-SUMMARY.md`.
</output>
