---
phase: 03-roast-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/format/yield.ts
  - src/features/roast-log/HistoryScreen.tsx
  - src/features/roast-log/ReviewScreen.tsx
  - src/features/roast-compare/CompareScreen.tsx
  - src/app/compare/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can select 2-3 roasts to compare"
    - "Comparison shows phase times and yield % for each selected roast"
    - "Changing the selection updates the comparison view"
  artifacts:
    - path: "src/features/roast-compare/CompareScreen.tsx"
      provides: "Compare screen with selection and derived comparison rows"
      min_lines: 120
    - path: "src/app/compare/page.tsx"
      provides: "Route entry for compare view"
      exports: ["default"]
    - path: "src/shared/format/yield.ts"
      provides: "Shared yield resolver/formatter for history + compare"
      exports: ["resolveYieldPercent", "formatYieldPercent"]
  key_links:
    - from: "src/features/roast-compare/CompareScreen.tsx"
      to: "src/data/roasts.ts"
      via: "liveQuery(listRoasts)"
      pattern: "liveQuery\(\(\) => listRoasts\(\)\)"
    - from: "src/features/roast-compare/CompareScreen.tsx"
      to: "src/domain/roast-session/derive.ts"
      via: "derivePhaseTimes"
      pattern: "derivePhaseTimes"
    - from: "src/features/roast-log/HistoryScreen.tsx"
      to: "src/app/compare/page.tsx"
      via: "Link href=\"/compare\""
      pattern: "href=\"/compare\""
---

<objective>
Add a dedicated roast comparison view that lets users pick 2-3 roasts and see phase times and yield percent side by side.

Purpose: Deliver the Phase 3 insight feature without new persistence by reusing existing roast data and derivation utilities.
Output: Compare route + screen, shared yield formatting helper, navigation entry point.
</objective>

<execution_context>
@/Users/bobsmachine/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bobsmachine/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/features/roast-log/HistoryScreen.tsx
@src/domain/roast-session/derive.ts
@src/data/roasts.ts
@src/shared/format/time.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Centralize yield formatting and expose compare entry</name>
  <files>src/shared/format/yield.ts, src/features/roast-log/HistoryScreen.tsx, src/features/roast-log/ReviewScreen.tsx</files>
  <action>
    Create `src/shared/format/yield.ts` exporting:
    - `resolveYieldPercent(roast: { yieldPercent?: number | null; lossPercent?: number | null }): number | null` that prefers `yieldPercent`, falls back to `100 - lossPercent`, else `null`.
    - `formatYieldPercent(value: number | null): string` returning "--" when null and `${value.toFixed(1)}%` otherwise.

    Update `src/features/roast-log/HistoryScreen.tsx` to import and use these helpers, removing the inline `resolveYieldPercent` and `formatYield` implementations. Add a new `Link` in the header actions (next to Back to timer) that routes to `/compare` with the same uppercase styling used for other nav links.

    Update `src/features/roast-log/ReviewScreen.tsx` to use `formatYieldPercent(yieldPercent)` for display, keeping the computed yield logic as-is. Do not change any data behavior or formulas.
  </action>
  <verify>npm run lint</verify>
  <done>History uses shared yield formatting, Review uses the shared formatter, and a visible /compare link is present in the history header.</done>
</task>

<task type="auto">
  <name>Task 2: Build compare screen with live data and 3-roast cap</name>
  <files>src/features/roast-compare/CompareScreen.tsx, src/app/compare/page.tsx</files>
  <action>
    Create `src/features/roast-compare/CompareScreen.tsx` as a client component that:
    - Subscribes to roasts via `liveQuery(() => listRoasts())`, plus `listLots()` and `listCoffees()` for lot labels, mirroring the HistoryScreen subscription/error patterns.
    - Maintains `selectedRoastIds` local state (array), enforcing a max of 3 selections. Disable additional checkboxes when 3 are selected and show a hint when fewer than 2 are selected.
    - Derives a compare view model with `useMemo` mapping selected roasts to `{ roast, times }` using `derivePhaseTimes`, and renders yield using `resolveYieldPercent` + `formatYieldPercent`.
    - Renders a selection list (checkboxes) with roast level, formatted date, and lot label; handle empty/loading/error states.
    - Renders a comparison grid/table with columns for each selected roast and rows for Total, Development, Cooling, and Yield % using `formatElapsedMsOrPlaceholder` for null times.
    - Match the existing tan card aesthetic (rounded borders, soft shadows, uppercase labels) and keep layout mobile-friendly.

    Add `src/app/compare/page.tsx` that renders `<CompareScreen />`.
  </action>
  <verify>npm run lint</verify>
  <done>/compare renders a selectable roast list, caps selections at 3, and updates the comparison grid whenever the selection changes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify roast comparison flow</name>
  <action>Confirm selection limits and derived metrics display as expected.</action>
  <what-built>Roast comparison screen with 2-3 selection and derived metrics</what-built>
  <how-to-verify>
    1. Run the app and visit `/compare`.
    2. Select two roasts; confirm Total/Development/Cooling/Yield % appear for both.
    3. Select a third roast; confirm a third column appears and further selections are disabled.
    4. Deselect one roast; confirm the grid updates immediately.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run lint`
- Manual check: comparison UI updates when selection changes and caps at 3
</verification>

<success_criteria>
- /compare lists roasts, allows selecting 2-3, and shows phase times + yield % for each selection
- History page provides a visible link to the compare view
- Yield formatting matches history and review screens
</success_criteria>

<output>
After completion, create `.planning/phases/03-roast-comparison/03-01-SUMMARY.md`
</output>
