---
phase: 04-private-access-gate
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - proxy.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees a passcode prompt before any app content is shown"
    - "User can unlock with the current passcode and stays unlocked for the browser session"
  artifacts:
    - path: "proxy.ts"
      provides: "Root proxy gate artifact for verification"
      contains: "rt_unlocked"
  key_links:
    - from: "proxy.ts"
      to: "/access"
      via: "redirect when session cookie missing"
      pattern: "redirect.*\/access"
    - from: "proxy.ts"
      to: "rt_unlocked"
      via: "request.cookies.get"
      pattern: "cookies\\.get\\(\"rt_unlocked\""
---

<objective>
Provide the required root proxy gate file as the single source of truth for verification.

Purpose: Close ACCESS-01 and ACCESS-03 gaps by ensuring `proxy.ts` directly contains the gate logic (no middleware or secondary copy).
Output: Root-level proxy gate file with `rt_unlocked` gate logic and path exclusions.
</objective>

<execution_context>
@/Users/bobsmachine/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bobsmachine/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add root proxy gate artifact matching active logic</name>
  <files>proxy.ts</files>
  <action>
Ensure `proxy.ts` at the repo root directly implements the gate logic (cookie check for `rt_unlocked`, redirect to `/access`, and ignored path handling) with the same matcher configuration used in Plan 01. Do not copy from or reference `src/proxy.ts`; treat the root file as the single source of truth to avoid drift. If `proxy.ts` already exists from Plan 01, only update it to match the Plan 01 specification.
  </action>
  <verify>npm run lint</verify>
  <done>`proxy.ts` exists at the repo root with redirect + cookie check logic and path exclusions matching the Plan 01 specification.</done>
</task>

</tasks>

<verification>
- Run `npm run lint`.
- Start the dev server and confirm: navigating to `/` redirects to `/access` and unlocking persists across tabs in the same browser session.
</verification>

<success_criteria>
- Verification can locate `proxy.ts` at the repo root with `rt_unlocked` checks and `/access` redirects.
- Access gate behavior remains unchanged with the root proxy as the single source of truth.
</success_criteria>

<output>
After completion, create `.planning/phases/04-private-access-gate/04-02-SUMMARY.md`
</output>
