---
phase: 04-private-access-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proxy.ts
  - src/app/access/page.tsx
  - src/app/api/access/unlock/route.ts
autonomous: true

must_haves:
  truths:
    - "User sees a passcode prompt before any app content is shown"
    - "User can unlock with the current passcode and stays unlocked for the browser session"
    - "Changing the server-configured passcode invalidates the previous one on next unlock"
    - "User sees a brief privacy notice on the passcode screen"
  artifacts:
    - path: "proxy.ts"
      provides: "Proxy gate redirect before app renders"
      contains: "rt_unlocked"
    - path: "src/app/api/access/unlock/route.ts"
      provides: "Server-side passcode validation and session cookie"
      exports: ["POST"]
    - path: "src/app/access/page.tsx"
      provides: "Full-screen passcode gate UI with privacy notice"
      contains: "Private Roast Timer"
  key_links:
    - from: "proxy.ts"
      to: "/access"
      via: "redirect when session cookie missing"
      pattern: "redirect.*\/access"
    - from: "proxy.ts"
      to: "rt_unlocked"
      via: "request.cookies.get"
      pattern: "cookies\\.get\\(\"rt_unlocked\""
    - from: "src/app/access/page.tsx"
      to: "/api/access/unlock"
      via: "fetch POST"
      pattern: "fetch\(.*api\/access\/unlock"
    - from: "src/app/api/access/unlock/route.ts"
      to: "process.env.PRIVATE_PASSCODE"
      via: "server-side comparison"
      pattern: "process\\.env\\.PRIVATE_PASSCODE"
    - from: "src/app/api/access/unlock/route.ts"
      to: "rt_unlocked"
      via: "cookies().set"
      pattern: "set\\(\"rt_unlocked\""
---

<objective>
Ship a passcode gate that blocks all app routes until unlocked and shows a privacy notice.

Purpose: Enforce private access without exposing the passcode in client code.
Output: Proxy gate, unlock API route handler, and access gate UI.
</objective>

<execution_context>
@/Users/bobsmachine/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bobsmachine/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/layout.tsx
@src/app/globals.css
@src/features/roast-log/HistoryScreen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce gate with proxy and session cookie unlock</name>
  <files>proxy.ts, src/app/api/access/unlock/route.ts</files>
  <action>
Create `proxy.ts` at the repo root to redirect any request without the `rt_unlocked` session cookie to `/access`, excluding `/access`, `/api`, `/_next/static`, `/_next/image`, and `favicon.ico` from the matcher to avoid redirect loops. Use Next.js 16 proxy API (not `middleware.ts`).

Add `POST` to `src/app/api/access/unlock/route.ts` that accepts `{ passcode }` JSON, compares to `process.env.PRIVATE_PASSCODE`, and returns 401 when missing or mismatched. On success, set an httpOnly session cookie named `rt_unlocked` with `path: "/"`, `sameSite: "lax"`, and no `maxAge`/`expires` so it clears on browser close; set `secure: true` in production. Do not log or return the passcode. Use this env var name per research default.
  </action>
  <verify>npm run lint</verify>
  <done>All non-access routes redirect to `/access` until `rt_unlocked` is set, and the unlock route sets the session cookie only when the server env passcode matches.</done>
</task>

<task type="auto">
  <name>Task 2: Build full-screen access gate UI with unlock flow</name>
  <files>src/app/access/page.tsx</files>
  <action>
Create a client-side `/access` page that renders a full-screen gate (modal-style) before any app UI. Match the existing tan/cream visual language and typography cues from the history screen. Include a single password input, a "show passcode" toggle that switches the input type, and the branding line "Private Roast Timer". Allow paste in the passcode field by default.

On submit, POST to `/api/access/unlock` with JSON and handle responses: on 200, clear errors and redirect to `/`; on 401, clear the passcode field and show the exact error message "Incorrect passcode". Show the brief privacy notice on this screen only; do not add any manual lock control or inactivity timer.
  </action>
  <verify>npm run lint</verify>
  <done>Gate screen blocks app UI, supports show/hide passcode, displays privacy notice, and failed unlocks clear the field while showing "Incorrect passcode".</done>
</task>

</tasks>

<verification>
- Run `npm run lint`.
- Start the dev server and confirm: navigating to `/` redirects to `/access`, a correct passcode unlocks and persists across tabs in the same session, and closing the browser requires re-unlock.
</verification>

<success_criteria>
- Access is blocked by default and only the passcode screen renders before unlock.
- Unlock uses `PRIVATE_PASSCODE` on the server and sets a session cookie shared across tabs.
- Privacy notice appears on the gate screen and nowhere else.
</success_criteria>

<output>
After completion, create `.planning/phases/04-private-access-gate/04-01-SUMMARY.md`
</output>
