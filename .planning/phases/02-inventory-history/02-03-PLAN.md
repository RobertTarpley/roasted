---
phase: 02-inventory-history
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/features/timer/timerStore.ts
  - src/features/roast-log/PreRoastForm.tsx
  - src/features/roast-log/ReviewScreen.tsx
  - src/features/roast-log/HistoryScreen.tsx
  - src/data/roasts.ts
  - src/data/lots.ts
  - src/data/coffees.ts
autonomous: true

must_haves:
  truths:
    - "User selects a lot before starting a roast and it is saved with the roast."
    - "Saving a roast auto-deducts the lot inventory based on green weight (grams to pounds)."
    - "User can filter roast history by coffee/lot, date range, and roast level."
  artifacts:
    - path: "src/features/roast-log/PreRoastForm.tsx"
      provides: "Lot selection in pre-roast flow"
    - path: "src/features/roast-log/HistoryScreen.tsx"
      provides: "Filterable history with lot/coffee labels"
    - path: "src/features/timer/timerStore.ts"
      provides: "Selected lot stored in roast session state"
  key_links:
    - from: "src/features/roast-log/ReviewScreen.tsx"
      to: "src/data/roasts.ts"
      via: "saveRoast with lotId"
      pattern: "saveRoast"
    - from: "src/features/roast-log/HistoryScreen.tsx"
      to: "src/data/roasts.ts"
      via: "listRoastsFiltered"
      pattern: "listRoastsFiltered"
---

<objective>
Connect roasts to lots and enable inventory-aware history filtering.

Purpose: Tie roast capture to inventory and let users review history by lot, date, and roast level.
Output: Updated roast flow, saved lot linkage, and filterable history UI.
</objective>

<execution_context>
@/Users/bobsmachine/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bobsmachine/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inventory-history/02-CONTEXT.md
@src/features/roast-log/PreRoastForm.tsx
@src/features/roast-log/ReviewScreen.tsx
@src/features/roast-log/HistoryScreen.tsx
@src/features/timer/timerStore.ts
@src/data/roasts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lot selection to the roast flow and save with inventory deduction</name>
  <files>
    src/features/timer/timerStore.ts
    src/features/roast-log/PreRoastForm.tsx
    src/features/roast-log/ReviewScreen.tsx
    src/data/roasts.ts
    src/data/lots.ts
    src/data/coffees.ts
  </files>
  <action>
    Update `timerStore` to track `selectedLotId: number | null` and include it in `beginRoast` input, reset, and validation paths. Add setter action if needed to update selection from the pre-roast form.
    In `PreRoastForm`, add a required lot selector above green weight. Use `liveQuery` to load lots joined with coffee names (via `listLots` + `listCoffees` lookups) and show them as `Coffee Name — Lot Label`. Validation should require a lot selection before starting the roast.
    In `ReviewScreen`, display the selected lot label in the summary and include `lotId` in the `saveRoast` call. Keep save logic using the repository so inventory auto-deduction occurs in the data layer transaction.
    Ensure any save errors are surfaced using existing error messaging patterns. Do not change yield or timing logic.
  </action>
  <verify>
    - npm run lint
    - Start a roast, select a lot, complete and save; confirm the lot appears in history and the lot inventory drops by greenWeight grams converted to lbs
  </verify>
  <done>Roasts require a lot selection and saved roasts carry lotId with inventory deducted automatically.</done>
</task>

<task type="auto">
  <name>Task 2: Add history filters for lot, date range, and roast level</name>
  <files>
    src/features/roast-log/HistoryScreen.tsx
    src/data/roasts.ts
  </files>
  <action>
    Add a filter section at the top of `HistoryScreen` with:
    - Coffee/lot single select (options built from coffees + lots; label as Coffee — Lot)
    - Date range start/end inputs (optional)
    - Roast level select (Light/Medium/Dark)
    - Clear/reset action that returns to default (all roasts)
    Use `listRoastsFiltered` with `liveQuery` so changes reactively update the list. Translate date inputs to timestamps representing the start/end of the day in local time. If no filters are set, show the full list.
    Update each roast card to show the linked coffee and lot labels. Keep existing delete-last functionality, relying on the updated repository to restore inventory.
  </action>
  <verify>
    - npm run lint
    - In /history, apply each filter independently and together; confirm the list narrows and reset clears filters
  </verify>
  <done>History filters by lot, date range, and roast level, and roast cards show coffee/lot labels.</done>
</task>

</tasks>

<verification>
- `npm run lint`
- Roast flow saves with selected lot and history filters update live.
</verification>

<success_criteria>
- Pre-roast requires a lot selection and saved roasts include lot linkage.
- Inventory auto-deducts on save using grams-to-lbs conversion.
- History filtering works for lot/date/roast level with a clear reset action.
</success_criteria>

<output>
After completion, create `.planning/phases/02-inventory-history/02-03-SUMMARY.md`
</output>
