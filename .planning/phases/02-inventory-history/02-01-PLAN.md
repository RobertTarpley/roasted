---
phase: 02-inventory-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/roast-session/types.ts
  - src/domain/inventory/types.ts
  - src/domain/inventory/validation.ts
  - src/domain/inventory/convert.ts
  - src/data/db.ts
  - src/data/roasts.ts
  - src/data/coffees.ts
  - src/data/lots.ts
  - src/data/adjustments.ts
autonomous: true

must_haves:
  truths:
    - "Inventory data (coffees, lots, adjustments) persists locally and can be queried."
    - "Roast records store a selected lot and link to inventory updates."
  artifacts:
    - path: "src/data/db.ts"
      provides: "Dexie schema v2 with coffees, lots, adjustments, and roasts lot index"
      contains: "version(2)"
    - path: "src/data/roasts.ts"
      provides: "Roast save/delete with inventory-aware transactions"
      exports: ["saveRoast", "deleteRoast", "listRoasts", "listRoastsFiltered"]
    - path: "src/domain/inventory/types.ts"
      provides: "Coffee, Lot, Adjustment, and Process types"
  key_links:
    - from: "src/data/roasts.ts"
      to: "src/data/db.ts"
      via: "db.transaction('rw', db.roasts, db.lots)"
      pattern: "transaction\(\"rw\""
    - from: "src/data/adjustments.ts"
      to: "src/data/db.ts"
      via: "db.transaction('rw', db.adjustments, db.lots)"
      pattern: "adjustments"
---

<objective>
Add inventory persistence and roast linkage foundations.

Purpose: Enable Phase 2 inventory management and history filtering to read/write consistent data.
Output: Inventory domain types + Dexie tables with repositories for coffees, lots, adjustments, and inventory-aware roasts.
</objective>

<execution_context>
@/Users/bobsmachine/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/bobsmachine/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inventory-history/02-CONTEXT.md
@.planning/phases/02-inventory-history/02-RESEARCH.md
@src/data/db.ts
@src/data/roasts.ts
@src/domain/roast-session/types.ts
@src/domain/roast-session/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define inventory domain types and validation</name>
  <files>
    src/domain/roast-session/types.ts
    src/domain/inventory/types.ts
    src/domain/inventory/validation.ts
    src/domain/inventory/convert.ts
  </files>
  <action>
    Create `src/domain/inventory/types.ts` with Coffee, Lot, and Adjustment types plus a CoffeeProcess union of: Natural, Washed, Honey/Pulped Natural, Experimental, Other (per locked decision). Include fields: id (optional), coffee name, optional origin, process, lot label, startingInventoryLbs, currentInventoryLbs, and adjustment amountLbs with reason (purchase | correction), createdAt timestamps.
    Add `src/domain/inventory/validation.ts` Zod schemas for coffee, lot, and adjustment inputs: coffee name required, process required from the fixed list, lot label required, starting inventory must be >= 0, adjustment amount non-zero and numeric (allow negative), reason required from purchase/correction. Keep messages consistent with existing form patterns.
    Add `src/domain/inventory/convert.ts` with `gramsToLbs(grams)` using 1 lb = 453.592 g and `normalizeLbs(value)` rounding to 3 decimals to avoid float drift.
    Update `src/domain/roast-session/types.ts` to include `lotId: number` on `CompletedRoast` (required for saved roasts) and allow `lotId?: number` on session state if needed for drafts.
  </action>
  <verify>npm run lint</verify>
  <done>Inventory types and validation exist with fixed process options, and roast types include lot linkage.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Dexie schema and repositories for inventory</name>
  <files>
    src/data/db.ts
    src/data/roasts.ts
    src/data/coffees.ts
    src/data/lots.ts
    src/data/adjustments.ts
    src/domain/inventory/convert.ts
  </files>
  <action>
    Bump Dexie schema in `src/data/db.ts` to version 2 and add stores:
    - `coffees: "++id, name, origin, process"`
    - `lots: "++id, coffeeId, label, currentInventoryLbs"`
    - `adjustments: "++id, lotId, createdAt, reason"`
    - Update `roasts` store to include `lotId` index alongside `startedAt` and `roastLevel` for filtering.
    Create `src/data/coffees.ts` with add/list/get helpers and `src/data/lots.ts` with add/list/get/update helpers. Store and update inventory in pounds, always normalizing to 3 decimals after writes.
    Create `src/data/adjustments.ts` with `addAdjustment` that uses a Dexie transaction to add an adjustment and update the lot inventory immediately; include `listAdjustmentsForLot` ordered by createdAt desc.
    Update `src/data/roasts.ts`:
    - `saveRoast` should accept `lotId` and run a `db.transaction("rw", db.roasts, db.lots, ...)` to add the roast and deduct inventory using `gramsToLbs` + `normalizeLbs`.
    - `deleteRoast` should restore inventory when a deleted roast has `lotId` (add back the roast green weight in lbs) in a single transaction with roasts + lots.
    - Add `listRoastsFiltered({ lotId?, roastLevel?, startAt?, endAt? })` using indexed queries (`where` + `between`) and apply any remaining filters in memory if a compound index is unavailable.
    Keep all transaction bodies free of non-Dexie async calls to avoid TransactionInactiveError.
  </action>
  <verify>npm run lint</verify>
  <done>Dexie v2 schema and repositories support coffees/lots/adjustments plus inventory-aware roast saves and deletes.</done>
</task>

</tasks>

<verification>
- `npm run lint`
- Inventory data can be created and queried via repository helpers in a local run (no runtime errors in console).
</verification>

<success_criteria>
- Dexie v2 schema loads with new tables and roasts include a lotId index.
- Repositories can add coffees, lots, and adjustments while keeping lot inventory consistent and normalized.
- Roast saves/deduction and deletes/restores run in a single transaction without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/02-inventory-history/02-01-SUMMARY.md`
</output>
